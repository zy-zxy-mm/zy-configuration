# IoT 组态控制面板 - 技术架构手册

## 1. 项目概述

IoT 组态控制面板是一个可视化的智能设备控制界面设计器，支持拖拽式设计、实时预览、版本管理和运行时设备控制。

## 2. 技术栈

### 2.1 前端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue 3 | 3.x | 前端框架，使用 Composition API |
| TypeScript | 5.x | 类型安全 |
| Ant Design Vue | 4.x | UI 组件库 |
| @ant-design/icons-vue | 7.x | 图标库 |
| Vue Router | 4.x | 路由管理 |
| Vite | 5.x | 构建工具 |
| Less | 4.x | CSS 预处理器 |

### 2.2 后端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 2.7.x | 后端框架 |
| MyBatis-Plus | 3.5.x | ORM 框架 |
| MySQL | 8.0 | 数据库 |
| WebSocket | - | 实时通信 |

## 3. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端应用                              │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│  PanelList  │ PanelDesign │ PanelRuntime│   PanelPreview   │
│  (面板列表)  │  (设计器)    │  (运行时)   │    (预览)        │
├─────────────┴─────────────┴─────────────┴──────────────────┤
│                    组件层 (Components)                       │
│  WidgetRenderer | PropertyEditor | BindingEditor | EventEditor│
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Data)                             │
│         widgetConfig.ts | panel.data.ts | panel.api.ts      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        后端服务                              │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│ PanelController│PageController│VersionController│RuntimeController│
├─────────────┴─────────────┴─────────────┴──────────────────┤
│                    服务层 (Service)                          │
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Mapper)                           │
├─────────────────────────────────────────────────────────────┤
│                    数据库 (MySQL)                            │
└─────────────────────────────────────────────────────────────┘
```

## 4. 目录结构

### 4.1 前端目录

```
huafeng-cloud-web/src/views/smartPark/configuration/
├── api/
│   └── panel.api.ts          # API 接口定义
├── components/
│   ├── WidgetRenderer.vue    # 组件渲染器（核心）
│   ├── PropertyEditor.vue    # 属性编辑器
│   ├── BindingEditor.vue     # 数据绑定编辑器
│   ├── EventEditor.vue       # 事件编辑器
│   ├── PanelModal.vue        # 面板弹窗
│   ├── PageModal.vue         # 页面弹窗
│   ├── PageDrawer.vue        # 页面抽屉
│   └── VersionModal.vue      # 版本弹窗
├── data/
│   ├── widgetConfig.ts       # 组件库配置（核心）
│   └── panel.data.ts         # 表格列配置
├── PanelList.vue             # 面板列表页
├── PanelDesign.vue           # 设计器页面（核心）
├── PanelRuntime.vue          # 运行时页面
└── PanelPreview.vue          # 预览页面
```

### 4.2 后端目录

```
huafeng-cloud-device/.../configuration/
├── controller/
│   ├── IotPanelController.java           # 面板管理
│   ├── IotPanelPageController.java       # 页面管理
│   ├── IotPanelPageVersionController.java# 版本管理
│   ├── IotPanelRuntimeController.java    # 运行时
│   ├── IotShadowController.java          # 设备影子
│   └── IotCommandController.java         # 命令下发
├── entity/
│   ├── IotPanel.java                     # 面板实体
│   ├── IotPanelPage.java                 # 页面实体
│   ├── IotPanelPageVersion.java          # 版本实体
│   ├── IotPanelPagePublish.java          # 发布实体
│   └── IotCommandAudit.java              # 命令审计
├── service/
│   ├── IIotPanelService.java
│   ├── IIotPanelPageService.java
│   ├── IIotPanelPageVersionService.java
│   ├── IotShadowService.java             # 设备影子服务
│   └── IotWebSocketService.java          # WebSocket服务
├── mapper/
│   └── ...Mapper.java
├── websocket/
│   ├── IotWebSocketHandler.java          # WebSocket处理器
│   └── WebSocketConfig.java              # WebSocket配置
└── sql/
    └── iot_panel_ddl.sql                 # 数据库DDL
```

## 5. 核心模块详解

### 5.1 组件库配置 (widgetConfig.ts)

组件库是整个系统的核心，定义了所有可用的控件类型。

```typescript
// 组件分类
export const widgetCategories = [
  { key: 'basic', name: '基础控件' },
  { key: 'lighting', name: '照明控制' },
  { key: 'hvac', name: '暖通空调' },
  { key: 'security', name: '安防设备' },
  { key: 'sensor', name: '传感器' },
  { key: 'display', name: '显示控件' },
  { key: 'input', name: '输入控件' },
];

// 组件定义结构
interface WidgetDefinition {
  type: string;           // 组件类型标识
  name: string;           // 显示名称
  category: string;       // 所属分类
  icon: string;           // 图标名称
  defaultSize: {          // 默认尺寸
    width: number;
    height: number;
  };
  props: {                // 可配置属性
    [key: string]: {
      type: 'string' | 'number' | 'boolean' | 'select' | 'color' | 'array';
      default: any;
      label: string;
      options?: string[];  // select 类型的选项
      min?: number;        // number 类型的最小值
      max?: number;        // number 类型的最大值
    };
  };
  binding?: {             // 数据绑定配置
    supportDataBinding?: boolean;
    dataType?: string;
    bindingLabel?: string;
    points?: Array<{      // 多点位绑定
      key: string;
      label: string;
      dataType: string;
    }>;
  };
  events?: Array<{        // 事件配置
    key: string;
    name: string;
    supportHttp: boolean;
    params?: string[];
  }>;
}
```

### 5.2 组件渲染器 (WidgetRenderer.vue)

负责根据组件类型渲染对应的 UI，是设计器和运行时共用的核心组件。

```vue
<template>
  <div class="widget-renderer">
    <!-- 根据 widget.type 渲染不同组件 -->
    <template v-if="widget.type === 'switch'">
      <div class="switch-widget">...</div>
    </template>
    <template v-else-if="widget.type === 'acCard'">
      <div class="ac-card-widget">...</div>
    </template>
    <!-- 更多组件类型... -->
  </div>
</template>

<script setup>
const props = defineProps({
  widget: Object,      // 组件实例数据
  isDesign: Boolean,   // 是否设计模式
  shadowState: Object, // 设备影子状态
  deviceId: String,    // 设备ID
});

const emit = defineEmits(['command', 'httpRequest']);
</script>
```

### 5.3 设计器 (PanelDesign.vue)

提供可视化拖拽设计功能。

**核心功能：**
- 组件拖拽放置
- 组件选中、移动、缩放
- 属性编辑
- 数据绑定配置
- 事件配置
- 撤销/重做
- 保存/发布

**数据结构：**
```typescript
interface WidgetInstance {
  id: string;           // 唯一标识
  type: string;         // 组件类型
  x: number;            // X 坐标
  y: number;            // Y 坐标
  width: number;        // 宽度
  height: number;       // 高度
  props: object;        // 属性值
  binding: {            // 绑定配置
    deviceId: string;
    points: object;
  };
  events: object;       // 事件配置
  style: {
    zIndex: number;
  };
}
```

### 5.4 运行时 (PanelRuntime.vue)

加载已发布的面板配置，连接设备进行实时控制。

**核心功能：**
- 加载发布配置
- WebSocket 连接
- 设备状态同步
- 命令下发
- HTTP 事件触发

## 6. 数据库设计

### 6.1 表结构

```sql
-- 面板表
CREATE TABLE iot_panel (
  id VARCHAR(36) PRIMARY KEY,
  panel_name VARCHAR(100) NOT NULL,
  panel_code VARCHAR(50) UNIQUE,
  description TEXT,
  status TINYINT DEFAULT 1,
  create_time DATETIME,
  update_time DATETIME
);

-- 页面表
CREATE TABLE iot_panel_page (
  id VARCHAR(36) PRIMARY KEY,
  panel_id VARCHAR(36) NOT NULL,
  page_name VARCHAR(100) NOT NULL,
  page_code VARCHAR(50),
  canvas_width INT DEFAULT 390,
  canvas_height INT DEFAULT 844,
  sort_order INT DEFAULT 0,
  create_time DATETIME
);

-- 版本表
CREATE TABLE iot_panel_page_version (
  id VARCHAR(36) PRIMARY KEY,
  page_id VARCHAR(36) NOT NULL,
  version_no INT NOT NULL,
  config_json LONGTEXT,
  change_log VARCHAR(500),
  create_time DATETIME,
  create_by VARCHAR(50)
);

-- 发布表
CREATE TABLE iot_panel_page_publish (
  id VARCHAR(36) PRIMARY KEY,
  page_id VARCHAR(36) NOT NULL,
  version_id VARCHAR(36) NOT NULL,
  config_json LONGTEXT,
  publish_time DATETIME,
  publish_by VARCHAR(50)
);

-- 命令审计表
CREATE TABLE iot_command_audit (
  id VARCHAR(36) PRIMARY KEY,
  device_id VARCHAR(50),
  command_key VARCHAR(50),
  command_params TEXT,
  result VARCHAR(20),
  error_msg TEXT,
  create_time DATETIME,
  create_by VARCHAR(50)
);
```

## 7. API 接口

### 7.1 面板管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /iot/panel/list | 获取面板列表 |
| POST | /iot/panel/add | 新增面板 |
| PUT | /iot/panel/edit | 编辑面板 |
| DELETE | /iot/panel/delete | 删除面板 |

### 7.2 页面管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /iot/panel/page/list | 获取页面列表 |
| GET | /iot/panel/page/{id} | 获取页面详情 |
| POST | /iot/panel/page/add | 新增页面 |

### 7.3 版本管理

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /iot/panel/version/save | 保存版本 |
| POST | /iot/panel/version/publish | 发布版本 |
| GET | /iot/panel/version/published | 获取已发布配置 |

### 7.4 运行时

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /iot/panel/runtime/config | 获取运行时配置 |
| POST | /iot/command/send | 发送设备命令 |
| GET | /iot/shadow/{deviceId} | 获取设备影子 |

## 8. 通信机制

### 8.1 WebSocket

用于实时推送设备状态变化。

```javascript
// 连接
const ws = new WebSocket(`ws://host/ws/iot/panel?deviceId=${deviceId}`);

// 接收消息
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  // data.type: 'shadow_update' | 'command_result'
  // data.payload: 具体数据
};
```

### 8.2 HTTP 事件

组件可配置 HTTP 事件，在用户操作时发送请求。

```typescript
interface HttpEventConfig {
  enabled: boolean;
  method: 'GET' | 'POST' | 'PUT' | 'DELETE';
  url: string;
  headers: Record<string, string>;
  bodyTemplate: string;  // 支持 ${value}, ${deviceId} 变量
  successMessage: string;
  errorMessage: string;
}
```

## 9. 现有组件清单

| 分类 | 组件类型 | 组件名称 |
|------|----------|----------|
| 基础控件 | button | 按钮 |
| 基础控件 | text | 文本 |
| 基础控件 | image | 图片 |
| 基础控件 | icon | 图标 |
| 基础控件 | container | 容器 |
| 照明控制 | switch | 开关 |
| 照明控制 | dimmer | 调光器 |
| 照明控制 | colorPicker | 色温/颜色 |
| 照明控制 | lightScene | 灯光场景 |
| 暖通空调 | acCard | 空调卡片 |
| 暖通空调 | thermostat | 温控器 |
| 暖通空调 | fanControl | 风扇控制 |
| 安防设备 | doorLock | 门锁控制 |
| 安防设备 | gateControl | 闸机控制 |
| 安防设备 | camera | 摄像头 |
| 安防设备 | alarm | 报警器 |
| 传感器 | tempHumidity | 温湿度 |
| 传感器 | airQuality | 空气质量 |
| 传感器 | powerMeter | 电表 |
| 传感器 | waterMeter | 水表 |
| 传感器 | occupancy | 人体感应 |
| 传感器 | lightSensor | 光照传感器 |
| 显示控件 | gauge | 仪表盘 |
| 显示控件 | progressBar | 进度条 |
| 显示控件 | statusIndicator | 状态指示灯 |
| 显示控件 | valueDisplay | 数值显示 |
| 输入控件 | slider | 滑块 |
| 输入控件 | select | 下拉选择 |
| 输入控件 | inputNumber | 数字输入 |
| 输入控件 | radioGroup | 单选组 |
| 输入控件 | segmented | 分段控制器 |
