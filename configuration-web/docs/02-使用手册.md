# IoT 组态控制面板 - 使用手册

## 1. 概述

本手册介绍如何在其他模块中引用已发布的组态面板，实现智能设备控制功能。

## 2. 快速开始

### 2.1 方式一：直接跳转到运行时页面

最简单的方式是通过路由跳转到运行时页面，传入页面ID和设备ID。

```vue
<template>
  <a-button @click="openControlPanel">打开控制面板</a-button>
</template>

<script setup>
import { useRouter } from 'vue-router';

const router = useRouter();

function openControlPanel() {
  router.push({
    path: '/smartPark/configuration/PanelRuntime',
    query: {
      pageId: 'your-page-id',      // 已发布的页面ID
      deviceId: 'your-device-id',  // 要控制的设备ID
    },
  });
}
</script>
```

### 2.2 方式二：新窗口打开

```javascript
function openInNewWindow() {
  const url = `/smartPark/configuration/PanelRuntime?pageId=${pageId}&deviceId=${deviceId}`;
  window.open(url, '_blank');
}
```

### 2.3 方式三：嵌入式引用（推荐）

在你的页面中嵌入控制面板组件。

```vue
<template>
  <div class="device-control-page">
    <div class="device-info">
      <!-- 设备信息展示 -->
      <h3>{{ deviceInfo.name }}</h3>
    </div>
    
    <!-- 嵌入控制面板 -->
    <EmbeddedPanel 
      :pageId="selectedPageId" 
      :deviceId="deviceInfo.id"
      @command="handleCommand"
    />
  </div>
</template>

<script setup>
import EmbeddedPanel from './components/EmbeddedPanel.vue';

const deviceInfo = ref({ id: 'device-001', name: '会议室空调' });
const selectedPageId = ref('page-id-xxx');

function handleCommand(cmd) {
  console.log('收到命令:', cmd);
}
</script>
```

## 3. 创建嵌入式面板组件

### 3.1 EmbeddedPanel.vue

```vue
<template>
  <div class="embedded-panel" :style="panelStyle">
    <div v-if="loading" class="loading-container">
      <a-spin tip="加载中..." />
    </div>
    <div v-else-if="error" class="error-container">
      <a-result status="error" :title="error" />
    </div>
    <div v-else class="panel-content">
      <div
        v-for="widget in widgets"
        :key="widget.id"
        class="widget-wrapper"
        :style="getWidgetStyle(widget)"
      >
        <WidgetRenderer
          :widget="widget"
          :isDesign="false"
          :shadowState="shadowState"
          :deviceId="deviceId"
          @command="handleCommand"
          @httpRequest="handleHttpRequest"
        />
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, computed } from 'vue';
import { message } from 'ant-design-vue';
import WidgetRenderer from '@/views/smartPark/configuration/components/WidgetRenderer.vue';
import { getRuntimeConfig, sendCommand } from '@/views/smartPark/configuration/api/panel.api';

const props = defineProps({
  pageId: { type: String, required: true },
  deviceId: { type: String, required: true },
  width: { type: Number, default: 390 },
  height: { type: Number, default: 600 },
});

const emit = defineEmits(['command', 'stateChange']);

const loading = ref(true);
const error = ref('');
const widgets = ref([]);
const canvasWidth = ref(390);
const canvasHeight = ref(844);
const shadowState = ref({});
let ws = null;

const panelStyle = computed(() => ({
  width: `${props.width}px`,
  height: `${props.height}px`,
  position: 'relative',
  overflow: 'auto',
  background: '#fff',
  borderRadius: '8px',
  boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
}));

onMounted(async () => {
  await loadConfig();
  connectWebSocket();
});

onUnmounted(() => {
  if (ws) {
    ws.close();
  }
});

async function loadConfig() {
  try {
    loading.value = true;
    const res = await getRuntimeConfig(props.pageId);
    if (res) {
      const config = typeof res === 'string' ? JSON.parse(res) : res;
      widgets.value = config.widgets || [];
      canvasWidth.value = config.canvasWidth || 390;
      canvasHeight.value = config.canvasHeight || 844;
    }
  } catch (e) {
    error.value = '加载面板配置失败';
    console.error(e);
  } finally {
    loading.value = false;
  }
}

function connectWebSocket() {
  const wsUrl = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws/iot/panel?deviceId=${props.deviceId}`;
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    console.log('WebSocket 已连接');
  };
  
  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      if (data.type === 'shadow_update') {
        shadowState.value = { ...shadowState.value, ...data.payload };
        emit('stateChange', shadowState.value);
      }
    } catch (e) {
      console.error('解析消息失败', e);
    }
  };
  
  ws.onclose = () => {
    console.log('WebSocket 已断开，5秒后重连...');
    setTimeout(connectWebSocket, 5000);
  };
}

function getWidgetStyle(widget) {
  const scale = props.width / canvasWidth.value;
  return {
    position: 'absolute',
    left: `${widget.x * scale}px`,
    top: `${widget.y * scale}px`,
    width: `${widget.width * scale}px`,
    height: `${widget.height * scale}px`,
  };
}

async function handleCommand(cmd) {
  emit('command', cmd);
  try {
    await sendCommand({
      deviceId: props.deviceId,
      commandKey: cmd.commandKey,
      params: cmd.params,
    });
    message.success('命令发送成功');
  } catch (e) {
    message.error('命令发送失败');
  }
}

async function handleHttpRequest({ config, params }) {
  // 处理 HTTP 事件
  const url = config.url.replace(/\$\{(\w+)\}/g, (_, key) => params[key] || '');
  const body = config.bodyTemplate.replace(/\$\{(\w+)\}/g, (_, key) => params[key] || '');
  
  try {
    const response = await fetch(url, {
      method: config.method,
      headers: config.headers,
      body: config.method !== 'GET' ? body : undefined,
    });
    
    if (response.ok) {
      message.success(config.successMessage || '操作成功');
    } else {
      message.error(config.errorMessage || '操作失败');
    }
  } catch (e) {
    message.error(config.errorMessage || '请求失败');
  }
}
</script>

<style scoped>
.embedded-panel {
  .loading-container,
  .error-container {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }
  
  .panel-content {
    position: relative;
    width: 100%;
    height: 100%;
  }
}
</style>
```

## 4. 完整示例：智能设备控制模块

### 4.1 设备列表页面

```vue
<!-- DeviceList.vue -->
<template>
  <div class="device-list-page">
    <a-table :dataSource="devices" :columns="columns">
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'action'">
          <a-button type="link" @click="openControl(record)">
            控制面板
          </a-button>
        </template>
      </template>
    </a-table>
    
    <!-- 控制面板弹窗 -->
    <a-modal
      v-model:open="controlVisible"
      :title="`${currentDevice?.name} - 控制面板`"
      width="450px"
      :footer="null"
    >
      <EmbeddedPanel
        v-if="currentDevice"
        :pageId="currentDevice.panelPageId"
        :deviceId="currentDevice.id"
        :width="400"
        :height="600"
      />
    </a-modal>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import EmbeddedPanel from './components/EmbeddedPanel.vue';

const devices = ref([
  { id: 'ac-001', name: '会议室空调', type: 'ac', panelPageId: 'page-ac-001' },
  { id: 'light-001', name: '大厅灯光', type: 'light', panelPageId: 'page-light-001' },
]);

const columns = [
  { title: '设备名称', dataIndex: 'name', key: 'name' },
  { title: '设备类型', dataIndex: 'type', key: 'type' },
  { title: '操作', key: 'action' },
];

const controlVisible = ref(false);
const currentDevice = ref(null);

function openControl(device) {
  currentDevice.value = device;
  controlVisible.value = true;
}
</script>
```

### 4.2 设备详情页面

```vue
<!-- DeviceDetail.vue -->
<template>
  <div class="device-detail-page">
    <a-row :gutter="16">
      <!-- 左侧：设备信息 -->
      <a-col :span="12">
        <a-card title="设备信息">
          <a-descriptions :column="1">
            <a-descriptions-item label="设备名称">{{ device.name }}</a-descriptions-item>
            <a-descriptions-item label="设备ID">{{ device.id }}</a-descriptions-item>
            <a-descriptions-item label="设备类型">{{ device.type }}</a-descriptions-item>
            <a-descriptions-item label="在线状态">
              <a-tag :color="device.online ? 'green' : 'red'">
                {{ device.online ? '在线' : '离线' }}
              </a-tag>
            </a-descriptions-item>
          </a-descriptions>
        </a-card>
        
        <a-card title="设备状态" style="margin-top: 16px">
          <pre>{{ JSON.stringify(deviceState, null, 2) }}</pre>
        </a-card>
      </a-col>
      
      <!-- 右侧：控制面板 -->
      <a-col :span="12">
        <a-card title="控制面板">
          <div class="panel-selector" style="margin-bottom: 16px">
            <span>选择面板：</span>
            <a-select v-model:value="selectedPageId" style="width: 200px">
              <a-select-option v-for="p in availablePanels" :key="p.id" :value="p.id">
                {{ p.name }}
              </a-select-option>
            </a-select>
          </div>
          
          <EmbeddedPanel
            v-if="selectedPageId"
            :pageId="selectedPageId"
            :deviceId="device.id"
            :width="380"
            :height="500"
            @stateChange="handleStateChange"
          />
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import EmbeddedPanel from './components/EmbeddedPanel.vue';
import { getDeviceDetail, getAvailablePanels } from './api/device.api';

const route = useRoute();
const deviceId = route.params.id;

const device = ref({});
const deviceState = ref({});
const availablePanels = ref([]);
const selectedPageId = ref('');

onMounted(async () => {
  // 加载设备信息
  device.value = await getDeviceDetail(deviceId);
  
  // 加载可用面板列表
  availablePanels.value = await getAvailablePanels(device.value.type);
  if (availablePanels.value.length > 0) {
    selectedPageId.value = availablePanels.value[0].id;
  }
});

function handleStateChange(state) {
  deviceState.value = state;
}
</script>
```

## 5. API 接口封装

### 5.1 panel.api.ts 扩展

```typescript
import { defHttp } from '@/utils/http/axios';

// 获取运行时配置
export function getRuntimeConfig(pageId: string) {
  return defHttp.get({ url: `/iot/panel/runtime/config?pageId=${pageId}` });
}

// 发送设备命令
export function sendCommand(data: {
  deviceId: string;
  commandKey: string;
  params: Record<string, any>;
}) {
  return defHttp.post({ url: '/iot/command/send', data });
}

// 获取设备影子状态
export function getDeviceShadow(deviceId: string) {
  return defHttp.get({ url: `/iot/shadow/${deviceId}` });
}

// 获取可用面板列表（按设备类型）
export function getPanelsByDeviceType(deviceType: string) {
  return defHttp.get({ url: `/iot/panel/list?deviceType=${deviceType}` });
}
```

## 6. 路由配置

如果需要独立的运行时页面，确保路由已配置：

```typescript
// staticRouter.ts
{
  path: '/smartPark/configuration/PanelRuntime',
  name: 'ConfigurationPanelRuntime',
  component: () => import('@/views/smartPark/configuration/PanelRuntime.vue'),
  meta: {
    title: '控制面板',
    hideMenu: true,
  },
}
```

## 7. 使用场景示例

### 7.1 场景一：设备管理列表中快速控制

在设备列表的操作列添加"控制"按钮，点击弹出控制面板。

### 7.2 场景二：大屏展示中嵌入控制面板

在可视化大屏中嵌入多个设备的控制面板。

```vue
<template>
  <div class="dashboard">
    <div class="panel-grid">
      <div v-for="device in devices" :key="device.id" class="panel-item">
        <h4>{{ device.name }}</h4>
        <EmbeddedPanel
          :pageId="device.panelPageId"
          :deviceId="device.id"
          :width="300"
          :height="400"
        />
      </div>
    </div>
  </div>
</template>
```

### 7.3 场景三：移动端 H5 页面

```vue
<template>
  <div class="mobile-control">
    <EmbeddedPanel
      :pageId="pageId"
      :deviceId="deviceId"
      :width="windowWidth"
      :height="windowHeight - 50"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';

const route = useRoute();
const pageId = route.query.pageId;
const deviceId = route.query.deviceId;

const windowWidth = ref(window.innerWidth);
const windowHeight = ref(window.innerHeight);

onMounted(() => {
  window.addEventListener('resize', () => {
    windowWidth.value = window.innerWidth;
    windowHeight.value = window.innerHeight;
  });
});
</script>
```

## 8. 注意事项

1. **设备ID传递**：运行时必须传入正确的设备ID，组件会根据设备ID获取状态和发送命令
2. **面板发布**：只有已发布的面板才能在运行时使用
3. **WebSocket连接**：确保后端WebSocket服务正常运行
4. **权限控制**：根据业务需求添加设备控制权限校验
5. **错误处理**：做好网络异常、设备离线等情况的处理
